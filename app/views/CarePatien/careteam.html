#{include '/tags/patientSummary.html' /}

<div class="col-xs-12 col-sm-12 nopadding">
	<button class="btn btn-default btn-sm careTeamBtn" style="font-weight:bold;" data-btn-type="addTeam">+ ADD NEW CARE TEAM</button>
	<br/><br/>
    #{if careTeams != null && careTeams.size()>0}
    	 <div class="col-xs-12" id="careTeamList">
    	#{list careTeams, as:'seq'}
	       	<h3 class="user_first" data-teamid="${seq.careteamid}" ><i class="fa fa-table"></i> ${seq.careteam.name} CARE TEAM
		       	<span style="margin-left: 50px;"><button class="btn btn-default-small careTeamBtn" data-btn-type="addTeamMember">+ ADD NEW CARE TEAM MEMBER</button></span>
		       	<span><button class="btn btn-danger-small careTeamBtn" data-btn-type="removeTeam">Remove care team</button></span>
	       	</h3>
	       	<div>Loading...</div>
		#{/list}
		</div>
    #{/if}
    #{else}
		<div class="row">
			<div class="col-sm-8">
					No Data found
			</div>
		</div>
	#{/else}
</div>
<script>
<!-- -->
$(document).ready(function() {

// 	$('button.careTeamBtn').click(function(event) {
		
// 	});

	$('body').on('click', 'button.careTeamBtn', function(e) {
// 1. addTeam
// 2. addTeamMember
// 3. removeTeam
// 4. removeTeamMember
// 5. makeMemberPrimary
// 6. editTeamLocation

		var operation = $(this).data("btn-type");
		if(operation == 'addTeam') {
			operationCareTeam('add');	
		} else if(operation == 'addTeamMember') {
			operationCareTeamMember('add');
		} else if(operation == 'removeTeam') {
			alert('Removing team');
		} else if(operation == 'removeTeamMember') {
			var memberId = $(this).data("member-id");
			alert('Removing team member: ' + memberId);
		} else if(operation == 'makeMemberPrimary') {
			var memberId = $(this).data("member-id");
			var teamid =  $(this).data("team-id");
			alert('Making member primary: ' + memberId);
			$.ajax({
				  type: 'POST',
				  url: '/carePatien/careteamOperation',
				  data: { 'operation':'makeprimary','memberid':memberId,'patientid':'${patientId}','teamid':teamid}
				  ,success:function(data) {
// 					  location.reload();
					  $('[data-team~="'+teamid+'"]').html(data);
				  },
				  error:function() {
				    alert('Some error');
				  }
			});
		} else if(operation == 'editTeamLocation') {
			alert('Edit team location');
		}
 	});

	var icons = {header: "ui-accordion-header-icon1 ui-icon-triangle-1-e",activeHeader: "ui-accordion-header-icon1 ui-icon-triangle-1-s"};
	$("#careTeamList").accordion({collapsible:true,heightStyle: "content" ,icons: icons,
		beforeActivate: function(event, ui) {
			if($(event.toElement).hasClass("careTeamBtn")) {
				return false; // Cancels the default action
			} else {
				if (ui.newHeader[0]) {
		               var currHeader  = ui.newHeader;
		               var currContent = currHeader.next('.ui-accordion-content');
		           } else {
		               var currHeader  = ui.oldHeader;
		               var currContent = currHeader.next('.ui-accordion-content');
		           }
		           var isPanelSelected = currHeader.attr('aria-selected') == 'true';
		           currHeader.toggleClass('accordion-header-active ui-corner-top',!isPanelSelected).attr('aria-selected',((!isPanelSelected).toString()));
		           currHeader.children('.ui-icon').toggleClass('ui-icon-triangle-1-e',isPanelSelected).toggleClass('ui-icon-triangle-1-s',!isPanelSelected);
		           currContent.toggleClass('accordion-content-active',!isPanelSelected)
					if (isPanelSelected) {
		        	   	currContent.slideUp(); 
					} else {
		               var teamId = $(currHeader).data('teamid');
		        	   currContent.slideDown();
		        	   $(currContent ).html('loading');
		        	   $.post( "/CarePatien/careteamSpecific", {d:new Date(),careTeamId:teamId,patientId:'${patientId}'}, function( data ) {
		            	   $(currContent ).html( data );
		            	 });
					}
					return false; // Cancels the default action
			}
           
       },
       create: function( event, ui ) {
		if (ui.header[0]) {
			var currHeader  = ui.header[0];
			var currContent = ui.content[0];
			var teamId = $(currHeader).data('teamid');
			$(currContent ).html('loading');
			$.post( "/CarePatien/careteamSpecific", {d:new Date(),careTeamId:teamId,patientId:'${patientId}'}, function( data ) {
           	   $(currContent ).html( data );
			});
		}
       }
	});
});

operationCareTeamMember = function(operation, id) {
	$('#addEditCareMemberTeam').appendTo("body").modal();
}

operationCareTeam = function(operation, id) {
	$('#addEditCareTeam').appendTo("body").modal();
}

function expandAll() {
	h3List = $('#careTeamList h3');
	for(j = 0;j<h3List.length;j++) {
		getTeamDetails( $(h3List[j]));
	}
    $('#careTeamList h3').removeClass('ui-state-default').removeClass('ui-state-active').removeClass('ui-corner-all').attr('aria-expanded', 'true').attr('aria-selected', 'true').attr('tabIndex', 0)
	.find('span.ui-icon').removeClass('ui-icon-triangle-1-e').addClass('ui-icon-triangle-1-s').closest('h3').next('div').show();
}
getTeamDetails = function(elm) {
	var teamId = $(elm).data('teamid');
	$.post( "/CarePatien/careteamSpecific", {d:new Date(),careTeamId:teamId,patientId:'${patientId}'}, function( data ) {
	 	$(elm).next('div').html( data );
	});
}

</script>
